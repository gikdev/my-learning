# https://taskfile.dev
version: '3'

dotenv: ['.env']

tasks:
  default: task --list-all

  dc:up: docker compose up -d
  dc:stop: docker compose stop
  dc:start: docker compose start
  dc:restart: docker compose restart
  dc:down: docker compose down
  dc:destroy: docker compose down -v

  db:harlequin:
    aliases: [ dbhq ]
    cmds:
      - harlequin -r -a postgres --dbname {{.DB_NAME}} --password1 {{.DB_PASSWORD}} --user {{.DB_USER}}
    requires:
      vars: [ DB_HOST, DB_PORT, DB_USER, DB_PASSWORD, DB_NAME ]

  run:
    aliases: [r]
    desc: Run the project
    cmds:
      - dotnet run ./Talyra.csproj
    requires:
      vars: [ ASPNETCORE_ENVIRONMENT, ASPNETCORE_URLS, DB_HOST, DB_PORT, DB_USER, DB_PASSWORD, DB_NAME ]

  migrate:
    aliases: [m]
    desc: Generate & run EF migrations for a given project
    cmds:
      - task: migration:generate
      - task: migration:apply

  migration:generate:
    aliases: [mg]
    desc: Generate EF migrations for a given project
    cmds:
      - dotnet ef migrations add {{.MIGRATION_NAME}} -o Migrations
    requires:
      vars: [ MIGRATION_NAME ]

  migration:apply:
    aliases: [ma]
    desc: Run EF migrations for a given project
    cmds:
      - dotnet ef database update -v
    requires:
      vars: []

  restore:
    desc: Restore the whole project
    cmds:
      - dotnet restore ./Talyra.slnx
