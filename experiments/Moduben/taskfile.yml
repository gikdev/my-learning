# https://taskfile.dev
version: '3'

vars:
  STARTUP_PATH: "./src/Ims.Api"
  MIGRATIONS_DIR: "Database/Migrations"

dotenv:
  - .env

tasks:
  default: task --list-all
  restore: dotnet restore ./Ims.slnx

  run:
    aliases: [r]
    desc: Run the project
    cmds:
      - dotnet run --project ./src/Ims.Api/

  run:prod:
    aliases: [rp]
    desc: Run the project with production environment variables
    dotenv:
      - .env.prod
    cmds:
      - dotnet run --project ./src/Ims.Api/

  migrate:
    aliases: [m]
    desc: Generate & run EF migrations for a given project
    cmds:
      - task: migration:generate
      - task: migration:apply

  migration:generate:
    aliases: [mg]
    desc: Generate EF migrations for a given project
    cmds:
      - dotnet ef migrations add {{.MIGRATION_NAME}} -p {{.PROJECT_PATH}} -s {{.STARTUP_PATH}} -o {{.MIGRATIONS_DIR}}
    requires:
      vars: [ MIGRATION_NAME, PROJECT_PATH, STARTUP_PATH, MIGRATIONS_DIR, POSTGRES_HOST, POSTGRES_PORT, POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB ]

  migration:apply:
    aliases: [ma]
    desc: Run EF migrations for a given project
    cmds:
      - dotnet ef database update -p {{.PROJECT_PATH}} -s {{.STARTUP_PATH}}
    requires:
      vars: [ PROJECT_PATH, STARTUP_PATH, POSTGRES_HOST, POSTGRES_PORT, POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB ]
